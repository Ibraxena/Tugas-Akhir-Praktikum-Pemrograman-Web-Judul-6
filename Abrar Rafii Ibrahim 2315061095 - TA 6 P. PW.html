<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Weather Dashboard â€“ AJAX & Web Service - Abrar Rafii Ibrahim 2315061095</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          fontFamily: {
            display: ["Poppins", "system-ui", "sans-serif"],
          },
          colors: {
            primary: "#6366f1",
            accent: "#22c55e",
            cardLight: "#f9fafb",
            cardDark: "#020617",
          },
          boxShadow: {
            soft: "0 22px 55px rgba(15,23,42,0.35)",
          },
        },
      },
    };
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

    ::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>

<body
  class="font-display bg-slate-100 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen flex items-center justify-center p-4"
>
  <div
    id="global-loader"
    class="fixed inset-0 bg-slate-900/10 dark:bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-40 opacity-0 pointer-events-none transition"
  >
    <div class="flex flex-col items-center gap-3">
      <div
        class="w-10 h-10 rounded-full border-2 border-primary border-t-transparent animate-spin"
      ></div>
      <p class="text-sm text-slate-700 dark:text-slate-200">
        Memuat data cuacaâ€¦
      </p>
    </div>
  </div>

  <div
    class="w-full max-w-5xl bg-gradient-to-br from-slate-50/90 via-slate-100/80 to-slate-50/90 dark:from-slate-900/90 dark:via-slate-950/95 dark:to-slate-900/90 rounded-3xl shadow-soft border border-slate-200/70 dark:border-slate-800/80 px-4 sm:px-8 py-6 space-y-6"
  >
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">
          Weather Dashboard
        </h1>
        <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 mt-1">
          Tugas Akhir â€“ AJAX & Web Service - Abrar Rafii Ibrahim 2315061095
        </p>
      </div>

      <div class="flex items-center gap-4">
        <div
          class="flex items-center text-xs sm:text-sm bg-slate-100 dark:bg-slate-900 rounded-full p-1 border border-slate-200 dark:border-slate-700"
        >
          <button
            id="btn-unit-c"
            class="px-3 py-1 rounded-full transition text-slate-600 dark:text-slate-300"
          >
            Â°C
          </button>
          <button
            id="btn-unit-f"
            class="px-3 py-1 rounded-full transition text-slate-600 dark:text-slate-300"
          >
            Â°F
          </button>
        </div>

        <button
          id="btn-theme"
          class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-200 hover:scale-105 hover:border-primary/70 transition"
          title="Toggle Light/Dark"
        >
          <svg
            id="icon-theme"
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
          </svg>
        </button>
      </div>
    </header>

    <section class="flex flex-col md:flex-row gap-4 relative">
      <div class="flex-1 relative">
        <div
          class="flex items-center gap-2 bg-white/80 dark:bg-slate-950/80 border border-slate-200 dark:border-slate-800 rounded-2xl px-4 py-2 shadow-sm focus-within:ring-2 focus-within:ring-primary/65 transition"
        >
          <span class="text-slate-400">
            <svg
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-5.2-5.2m1.2-4A7 7 0 1110 3a7 7 0 017 7z"
              />
            </svg>
          </span>
          <input
            id="input-city"
            type="text"
            placeholder="Cari kotaâ€¦ (misal: Jakarta)"
            class="flex-1 bg-transparent outline-none text-sm sm:text-base placeholder:text-slate-400"
            autocomplete="off"
          />
          <button
            id="btn-search"
            class="px-3 py-1.5 text-xs sm:text-sm rounded-xl bg-primary text-white hover:bg-primary/90 transition"
          >
            Cari
          </button>
          <button
            id="btn-save-fav"
            class="px-3 py-1.5 text-xs sm:text-sm rounded-xl border border-amber-400/60 text-amber-500 bg-amber-50/70 dark:bg-slate-900 hover:bg-amber-100/80 dark:hover:bg-slate-800 transition"
            title="Simpan kota ke favorit"
          >
            â˜†
          </button>
        </div>

        <div
          id="autocomplete-panel"
          class="absolute left-0 right-0 mt-2 bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-lg max-h-56 overflow-y-auto text-sm hidden z-20"
        ></div>
      </div>

      <div class="flex items-center gap-3 self-stretch md:self-auto">
        <button
          id="btn-refresh"
          class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 rounded-2xl bg-emerald-500/90 hover:bg-emerald-500 text-white text-xs sm:text-sm shadow-md hover:shadow-lg transition"
        >
          <span>Refresh</span>
        </button>
        <div class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400">
          <p id="last-updated">Belum ada update</p>
          <p class="opacity-70">Auto refresh tiap 5 menit</p>
        </div>
      </div>
    </section>

    <div
      id="error-banner"
      class="hidden rounded-2xl border border-red-300/70 bg-red-50 text-red-700 text-xs sm:text-sm px-4 py-2"
    ></div>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <article
        id="current-card"
        class="lg:col-span-2 bg-cardLight/80 dark:bg-cardDark/80 rounded-3xl border border-slate-200/70 dark:border-slate-800/80 p-5 sm:p-6 shadow-md relative overflow-hidden"
      >
        <div
          class="absolute inset-0 bg-gradient-to-br from-primary/10 via-transparent to-emerald-500/10 pointer-events-none"
        ></div>
        <div class="relative" id="current-content">
          <p
            class="text-center text-slate-500 dark:text-slate-400 text-sm py-10"
          >
            Masukkan nama kota untuk menampilkan cuaca terkini.
          </p>
        </div>
      </article>

      <aside
        class="bg-cardLight/80 dark:bg-cardDark/80 rounded-3xl border border-slate-200/70 dark:border-slate-800/80 p-4 sm:p-5 shadow-md flex flex-col gap-3"
      >
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold tracking-wide uppercase">
            Kota Favorit
          </h2>
        </div>
        <div
          id="fav-list"
          class="flex flex-wrap gap-2 text-xs sm:text-sm min-h-[3rem]"
        >
          <p
            class="text-slate-500 dark:text-slate-400 text-[11px] sm:text-xs italic"
          >
            Belum ada kota favorit. Simpan kota setelah melakukan pencarian.
          </p>
        </div>
      </aside>
    </section>

    <section
      id="forecast-wrapper"
      class="bg-cardLight/80 dark:bg-cardDark/80 rounded-3xl border border-slate-200/70 dark:border-slate-800/80 p-4 sm:p-5 shadow-md space-y-3 hidden"
    >
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-sm font-semibold tracking-wide uppercase">
          Prakiraan 5 Hari
        </h2>
      </div>
      <div
        id="forecast-scroll"
        class="flex gap-3 overflow-x-auto pb-1 text-xs sm:text-sm"
      ></div>
    </section>
  </div>

  <script>
    const API_KEY = "5c010a7144fdb326081318d4ac2e77ce";
    const REFRESH_INTERVAL = 5 * 60 * 1000;

    let unit = localStorage.getItem("wd_unit") || "metric";
    let theme = localStorage.getItem("wd_theme") || "light";
    let favorites = JSON.parse(localStorage.getItem("wd_favorites") || "[]");
    let historyCities = JSON.parse(localStorage.getItem("wd_history") || "[]");
    let currentCity = localStorage.getItem("wd_lastCity") || "";
    let autoTimer = null;

    const loaderOverlay = document.getElementById("global-loader");
    const errorBanner = document.getElementById("error-banner");
    const inputCity = document.getElementById("input-city");
    const btnSearch = document.getElementById("btn-search");
    const btnSaveFav = document.getElementById("btn-save-fav");
    const btnRefresh = document.getElementById("btn-refresh");
    const btnUnitC = document.getElementById("btn-unit-c");
    const btnUnitF = document.getElementById("btn-unit-f");
    const btnTheme = document.getElementById("btn-theme");
    const iconTheme = document.getElementById("icon-theme");
    const currentContent = document.getElementById("current-content");
    const lastUpdatedLabel = document.getElementById("last-updated");
    const favList = document.getElementById("fav-list");
    const forecastWrapper = document.getElementById("forecast-wrapper");
    const forecastScroll = document.getElementById("forecast-scroll");
    const autocompletePanel = document.getElementById("autocomplete-panel");

    function setLoader(visible) {
      loaderOverlay.style.opacity = visible ? "1" : "0";
      loaderOverlay.style.pointerEvents = visible ? "auto" : "none";
    }

    function showError(message) {
      errorBanner.textContent = message;
      errorBanner.classList.remove("hidden");
      setTimeout(() => errorBanner.classList.add("hidden"), 4000);
    }

    function formatTemp(value) {
      const rounded = Math.round(value);
      const suffix = unit === "metric" ? "Â°C" : "Â°F";
      return `${rounded}${suffix}`;
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString("id-ID", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
      });
    }

    function applyTheme() {
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
        iconTheme.innerHTML =
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
      } else {
        document.documentElement.classList.remove("dark");
        iconTheme.innerHTML =
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8-9h1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 7a5 5 0 100 10 5 5 0 000-10z" />';
      }
      localStorage.setItem("wd_theme", theme);
    }

    function applyUnitStyle() {
      const active =
        "bg-slate-900 text-slate-100 dark:bg-slate-50 dark:text-slate-900";
      const inactive = "bg-transparent text-slate-600 dark:text-slate-300";
      btnUnitC.className =
        "px-3 py-1 rounded-full text-xs sm:text-sm transition " +
        (unit === "metric" ? active : inactive);
      btnUnitF.className =
        "px-3 py-1 rounded-full text-xs sm:text-sm transition " +
        (unit === "imperial" ? active : inactive);
      localStorage.setItem("wd_unit", unit);
    }

    function renderFavorites() {
      favList.innerHTML = "";
      if (!favorites.length) {
        favList.innerHTML =
          '<p class="text-slate-500 dark:text-slate-400 text-[11px] sm:text-xs italic">Belum ada kota favorit.</p>';
        return;
      }
      favorites.forEach((name) => {
        const chip = document.createElement("button");
        chip.className =
          "px-3 py-1 rounded-full bg-slate-900/5 dark:bg-slate-50/5 border border-slate-200/70 dark:border-slate-700/80 hover:border-primary/70 hover:bg-primary/5 dark:hover:bg-primary/15 text-xs sm:text-sm flex items-center gap-1";
        chip.innerHTML = `<span>${name}</span><span class="text-[10px] text-slate-400 hover:text-red-400 remove">Ã—</span>`;
        chip.addEventListener("click", (e) => {
          if (e.target.classList.contains("remove")) {
            favorites = favorites.filter((c) => c !== name);
            localStorage.setItem("wd_favorites", JSON.stringify(favorites));
            renderFavorites();
          } else {
            inputCity.value = name;
            performSearch(name);
          }
        });
        favList.appendChild(chip);
      });
    }

    function toggleFavorite(city) {
      if (!city) return;
      if (favorites.includes(city)) {
        favorites = favorites.filter((c) => c !== city);
      } else {
        favorites.unshift(city);
      }
      localStorage.setItem("wd_favorites", JSON.stringify(favorites));
      renderFavorites();
    }

    const staticCities = [
      "Jakarta",
      "Bandung",
      "Surabaya",
      "Yogyakarta",
      "Medan",
      "Denpasar",
      "Tokyo",
      "London",
      "New York",
      "Sydney",
    ];

    function updateAutocomplete(query) {
      const q = query.trim().toLowerCase();
      if (!q) {
        autocompletePanel.classList.add("hidden");
        return;
      }

      const source = Array.from(
        new Set([...favorites, ...historyCities, ...staticCities])
      );
      const items = source.filter((c) => c.toLowerCase().includes(q)).slice(0, 7);

      if (!items.length) {
        autocompletePanel.classList.add("hidden");
        return;
      }

      autocompletePanel.innerHTML = "";
      items.forEach((name, idx) => {
        const row = document.createElement("div");
        row.className =
          "px-4 py-2 cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 " +
          (idx === 0 ? "rounded-t-2xl " : "") +
          (idx === items.length - 1 ? "rounded-b-2xl " : "");
        row.textContent = name;
        row.addEventListener("click", () => {
          inputCity.value = name;
          autocompletePanel.classList.add("hidden");
          performSearch(name);
        });
        autocompletePanel.appendChild(row);
      });

      autocompletePanel.classList.remove("hidden");
    }

    document.addEventListener("click", (e) => {
      if (
        !autocompletePanel.contains(e.target) &&
        e.target !== inputCity
      ) {
        autocompletePanel.classList.add("hidden");
      }
    });

    async function fetchWeather(city) {
      if (!city) return;
      setLoader(true);
      errorBanner.classList.add("hidden");

      const base = "https://api.openweathermap.org/data/2.5";
      const params = `q=${encodeURIComponent(city)}&appid=${API_KEY}&units=${unit}&lang=id`;

      try {
        const [nowRes, forecastRes] = await Promise.all([
          fetch(`${base}/weather?${params}`),
          fetch(`${base}/forecast?${params}`),
        ]);

        if (!nowRes.ok) {
          throw new Error("Kota tidak ditemukan atau API bermasalah.");
        }

        const nowData = await nowRes.json();
        const forecastData = await forecastRes.json();

        renderCurrent(nowData);
        renderForecast(forecastData);

        lastUpdatedLabel.textContent =
          "Terakhir diperbarui: " + formatTime(Date.now());

        currentCity = city;
        localStorage.setItem("wd_lastCity", city);
        if (!historyCities.includes(city)) {
          historyCities.unshift(city);
          historyCities = historyCities.slice(0, 20);
          localStorage.setItem("wd_history", JSON.stringify(historyCities));
        }
        scheduleAutoRefresh();
      } catch (err) {
        console.error(err);
        showError(err.message || "Gagal mengambil data cuaca.");
      } finally {
        setLoader(false);
      }
    }

    function renderCurrent(data) {
      const temp = formatTemp(data.main.temp);
      const feels = formatTemp(data.main.feels_like);
      const humidity = data.main.humidity;
      const wind = data.wind.speed;
      const condition = (data.weather[0]?.description || "").replace(
        /\b\w/g,
        (c) => c.toUpperCase()
      );
      const icon = data.weather[0]?.icon;
      const cityName = data.name + (data.sys?.country ? ", " + data.sys.country : "");

      currentContent.innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
          <div class="space-y-3">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500 dark:text-slate-400">Cuaca Saat Ini</p>
            <h2 class="text-2xl sm:text-3xl font-semibold">${cityName}</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">Kondisi: <span class="font-medium text-slate-800 dark:text-slate-100">${condition}</span></p>
            <button
              id="btn-current-fav"
              class="mt-2 inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs border ${
                favorites.includes(currentCity)
                  ? "border-amber-400 bg-amber-50/80 text-amber-600 dark:bg-amber-500/10"
                  : "border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:border-amber-400 hover:bg-amber-50/60 dark:hover:bg-amber-500/10"
              } transition"
            >
              <span>${favorites.includes(currentCity) ? "Favorit" : "Jadikan Favorit"}</span>
            </button>
          </div>

          <div class="flex items-center gap-4 sm:gap-6">
            <div class="relative">
              <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-3xl bg-gradient-to-br from-primary/80 to-emerald-400 flex items-center justify-center shadow-lg">
                <span class="text-2xl sm:text-3xl font-semibold text-white">${temp.replace(/[^\d-]/g,"")}</span>
              </div>
              <span class="absolute -right-3 -top-3 text-xs px-2 py-0.5 rounded-full bg-white/90 dark:bg-slate-900/90 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200">
                ${temp.replace(/[\d-]/g,"")}
              </span>
            </div>

            <div class="space-y-1 text-xs sm:text-sm">
              <div class="flex items-center gap-2">
                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-primary/10 text-primary">
                  ðŸ’§
                </span>
                <span>Kelembaban <span class="font-medium">${humidity}%</span></span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-primary/10 text-primary">
                  ðŸŒ¬
                </span>
                <span>Angin <span class="font-medium">${wind} ${
        unit === "metric" ? "m/s" : "mph"
      }</span></span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-primary/10 text-primary">
                  ðŸŒ¡
                </span>
                <span>Terasa seperti <span class="font-medium">${feels}</span></span>
              </div>
            </div>
          </div>
        </div>
      `;

      const btnCurrentFav = document.getElementById("btn-current-fav");
      if (btnCurrentFav) {
        btnCurrentFav.addEventListener("click", () => {
          toggleFavorite(currentCity);
          renderCurrent(data);
        });
      }
    }

    function renderForecast(data) {
      const list = data.list || [];
      const byDate = {};
      list.forEach((item) => {
        const dateKey = item.dt_txt.split(" ")[0];
        if (!byDate[dateKey]) byDate[dateKey] = [];
        byDate[dateKey].push(item);
      });

      const dates = Object.keys(byDate).slice(0, 5);
      forecastScroll.innerHTML = "";
      if (!dates.length) {
        forecastWrapper.classList.add("hidden");
        return;
      }

      dates.forEach((d) => {
        const entries = byDate[d];
        const middle = entries[Math.floor(entries.length / 2)];
        const temps = entries.map((e) => e.main.temp);
        const min = Math.min(...temps);
        const max = Math.max(...temps);
        const icon = middle.weather[0]?.icon;
        const desc = (middle.weather[0]?.description || "").replace(
          /\b\w/g,
          (c) => c.toUpperCase()
        );
        const dateObj = new Date(d);

        const card = document.createElement("div");
        card.className =
          "min-w-[130px] sm:min-w-[150px] bg-slate-50/90 dark:bg-slate-900/80 border border-slate-200/70 dark:border-slate-700/80 rounded-2xl px-3 py-3 flex flex-col items-center gap-1 shadow-sm";
        card.innerHTML = `
          <p class="text-[11px] uppercase tracking-[0.2em] text-slate-400 mb-1">${dateObj.toLocaleDateString(
            "id-ID",
            { weekday: "short" }
          )}</p>
          <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">${dateObj.toLocaleDateString(
            "id-ID",
            { day: "2-digit", month: "short" }
          )}</p>
          ${
            icon
              ? `<img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="" class="w-10 h-10 mb-1" />`
              : ""
          }
          <p class="text-[11px] text-center text-slate-600 dark:text-slate-300 mb-1">${desc}</p>
          <p class="text-xs font-semibold text-slate-900 dark:text-slate-100">${formatTemp(
            max
          )}</p>
          <p class="text-[11px] text-slate-400">Min ${formatTemp(min)}</p>
        `;
        forecastScroll.appendChild(card);
      });

      forecastWrapper.classList.remove("hidden");
    }

    function scheduleAutoRefresh() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(() => {
        if (currentCity) {
          fetchWeather(currentCity);
        }
      }, REFRESH_INTERVAL);
    }

    function performSearch(cityFromInput) {
      const city = (cityFromInput || inputCity.value || "").trim();
      if (!city) return;
      autocompletePanel.classList.add("hidden");
      fetchWeather(city);
    }

    btnSearch.addEventListener("click", () => performSearch());
    inputCity.addEventListener("keydown", (e) => {
      if (e.key === "Enter") performSearch();
    });
    inputCity.addEventListener("input", (e) =>
      updateAutocomplete(e.target.value)
    );

    btnSaveFav.addEventListener("click", () => {
      const city = (inputCity.value || currentCity || "").trim();
      if (!city) return;
      toggleFavorite(city);
    });

    btnRefresh.addEventListener("click", () => {
      if (currentCity) fetchWeather(currentCity);
    });

    btnUnitC.addEventListener("click", () => {
      if (unit !== "metric") {
        unit = "metric";
        applyUnitStyle();
        if (currentCity) fetchWeather(currentCity);
      }
    });
    btnUnitF.addEventListener("click", () => {
      if (unit !== "imperial") {
        unit = "imperial";
        applyUnitStyle();
        if (currentCity) fetchWeather(currentCity);
      }
    });

    btnTheme.addEventListener("click", () => {
      theme = theme === "light" ? "dark" : "light";
      applyTheme();
    });

    (function init() {
      applyTheme();
      applyUnitStyle();
      renderFavorites();

      if (currentCity) {
        inputCity.value = currentCity;
        fetchWeather(currentCity);
      }
    })();
  </script>
</body>
</html>